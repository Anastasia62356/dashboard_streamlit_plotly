#ã‚»ãƒ«ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ã™ã‚‹
#%%writefile app.py

import streamlit as st  #Streamli
import os #ç’°å¢ƒå¤‰æ•°
from google import genai # gemini api

# ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ API ã‚­ãƒ¼ã‚’å–å¾—
API_KEY = os.getenv('GEMINI_API_KEY')


# Gemini ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
client = genai.Client(api_key=API_KEY)


# =========================================================
# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã®åˆæœŸåŒ–
# =========================================================
# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã§è‡ªå·±PRç”Ÿæˆçµæœã‚’ä¿æŒ
if 'generated_ge' not in st.session_state:
    st.session_state["generated_ge"] = ""
# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã§è‡ªå·±PRç”Ÿæˆçµæœã®æ–‡å­—æ•°ã‚’ä¿æŒ
if 'now_char_count' not in st.session_state:
    st.session_state["now_char_count"] = 0
# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã§AIè³ªå•ç”Ÿæˆçµæœã‚’ä¿æŒ
if 'generated_qu' not in st.session_state:
    st.session_state["generated_qu"] = ""
# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã§AIè©•ä¾¡ç”Ÿæˆçµæœã‚’ä¿æŒ
if 'generated_ev' not in st.session_state:
    st.session_state["generated_ev"] = ""
# è¿½è·¡ç”¨ã‚¹ãƒ†ãƒ¼ãƒˆï¼šç”Ÿæˆä¸­ã‹ã©ã†ã‹ã‚’ç®¡ç†
if 'is_generating' not in st.session_state:
    st.session_state["is_generating"] = False
# è¡¨ç¤ºåˆ¤å®šã‚¹ãƒ†ãƒ¼ãƒˆï¼šæ—¢ã«è¡¨ç¤ºã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç®¡ç†
if 'displayed' not in st.session_state:
    st.session_state['displayed'] = False

# ----------------------------------------
# ãƒ¡ã‚¤ãƒ³å‡¦ç†
# ----------------------------------------
#ã‚µã‚¤ãƒ‰ãƒãƒ¼
st.sidebar.title("è¨­å®š")

#ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
user_mode = st.sidebar.radio("ãƒ¢ãƒ¼ãƒ‰", ["è‡ªå·±PRç”Ÿæˆ", "AIé¢æ¥è³ªå•","AIé¢æ¥è©•ä¾¡"])

#ã‚¿ã‚¤ãƒˆãƒ«
st.title(user_mode)

# ----------------------------------------
# è‡ªå·±PRã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿
# ----------------------------------------
def PR_GE():

    #ä¿æŒå‡ºåŠ›å†…å®¹è¡¨ç¤ºãƒ•ãƒ©ã‚°
    st.session_state['displayed'] = False
    #åˆ©ç”¨ã‚·ãƒ¼ãƒ³ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
    user_use = st.sidebar.radio("åˆ©ç”¨ã‚·ãƒ¼ãƒ³", ["æ–°å’é¸è€ƒ", "ä¸­é€”é¸è€ƒ","å…¥å­¦é¸è€ƒ"])


    #è·ç¨®å­¦ç§‘å…¥åŠ›
    user_job_or_subject = st.sidebar.text_input("å¿—æœ›ã™ã‚‹è·ç¨®ã¾ãŸã¯å­¦æ ¡")


    #æ–‡å­—æ•°ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
    char_count = st.sidebar.slider("æ–‡å­—æ•°ã‚’é¸æŠ", 150, 450, 150)
    max_char_count = char_count + 20
    min_char_count = char_count - 20


    #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›
    user_keywords_ge = st.text_area(
        "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (å¼·ã¿ã€ã‚¹ã‚­ãƒ«ã€å®Ÿç¸¾ãªã©ã‚’è¤‡æ•°è¡Œã§å…¥åŠ›)",
        placeholder="ä¾‹:\nPythonã¨ãƒ‡ãƒ¼ã‚¿åˆ†æã‚¹ã‚­ãƒ«\nãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼çµŒé¨“3å¹´\né¡§å®¢æº€è¶³åº¦20%å‘ä¸Šã«è²¢çŒ®"
    )

    #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆåŒ–
    keyword_list = [k.strip() for k in user_keywords_ge.split('\n') if k.strip()]
    keywords_formatted = "\n- " + "\n- ".join(keyword_list)

    #ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰å…¥åŠ›
    user_episode = st.text_area(
        "å®Ÿç¸¾ã®è©³ç´°ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ (PRã«å«ã‚ãŸã„å…·ä½“çš„ãªèƒŒæ™¯ãƒ»è¡Œå‹•ãƒ»çµæœ)",
        placeholder="ä¾‹:\nå‰è·ã§ãƒ‡ãƒ¼ã‚¿åé›†ã®è‡ªå‹•åŒ–ã‚’ææ¡ˆã€‚Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è‡ªä½œã—ã€ä½œæ¥­æ™‚é–“ã‚’é€±10æ™‚é–“å‰Šæ¸›ã€‚"
    )



    #Geminié€ä¿¡ãƒ—ãƒ­ãƒ³ãƒˆ
    prompt = f"""
    ã‚ãªãŸã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æˆåŠŸã®ãŸã‚ã«ã€**æ–‡å­—æ•°ã¨å…¨ã¦ã®åˆ¶ç´„ã‚’çµ¶å¯¾å³å®ˆã™ã‚‹ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆ**ã§ã™ã€‚

    ã€çµ¶å¯¾å³å®ˆãƒ«ãƒ¼ãƒ«ã€‘
    1. **ç”Ÿæˆã™ã‚‹æ–‡ç« ã¯ã€**ä¸Šé™**{max_char_count}å­—**ã‚’**çµ¶å¯¾ã«è¶…ãˆã¦ã¯ã„ã‘ã¾ã›ã‚“**ã€‚ã•ã‚‰ã«ã€**{min_char_count}å­—ä»¥ä¸Š**ã«åã‚ã‚‹ã“ã¨ã‚’**çµ¶å¯¾å³å®ˆ**ã—ã¦ãã ã•ã„ã€‚
    2. **ç”Ÿæˆã™ã‚‹æ–‡ç« å¥èª­ç‚¹ã‚’ä½¿ç”¨ã—ã€**ç©ºç™½ã€æ”¹è¡Œã‚’ä¸€åˆ‡ä½¿ç”¨ã›ãš**ã€æ–‡å­—ã®ã¿ã§æ§‹æˆã™ã‚‹ã“ã¨ã€‚
    3. **å›ç­”ã¯è‡ªå·±PRã®æœ¬æ–‡ã®ã¿**ã¨ã—ã€ã€Œæ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€ãªã©ã®å‰ç½®ãã‚„ã€æ–‡å­—æ•°ã«é–¢ã™ã‚‹æ³¨é‡ˆã€ã‚¿ã‚¤ãƒˆãƒ«ã¯ä¸€åˆ‡ä»˜ã‘ãªã„ã“ã¨ã€‚

    ã€ç”Ÿæˆã‚¿ã‚¹ã‚¯ã€‘
    ä»¥ä¸‹ã®ã€å‰ææ¡ä»¶ã€‘ã¨ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€‘ã‚’åŸºã«ã€é­…åŠ›çš„ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«éŸ¿ã{user_use}æ´»å‹•ç”¨ã®è‡ªå·±PRã‚’**å³å¯†ã«{min_char_count}å­—ã‹ã‚‰{max_char_count}å­—ã®é–“**ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

    ã€å‰ææ¡ä»¶ã€‘
    åˆ©ç”¨ã‚·ãƒ¼ãƒ³ - {user_use}
    è·ç¨®ã¾ãŸã¯å­¦ç§‘ - {user_job_or_subject}
    ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ - {user_episode}

    ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€‘
    ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ - {keywords_formatted}

    â€»å‰å›ã®ç”Ÿæˆã¯ {st.session_state['now_char_count']} æ–‡å­—ã§ã—ãŸã€‚
    â€»ä»Šå›ã®æ–‡ç« ã¯ã€å¿…ãš {min_char_count} æ–‡å­—ä»¥ä¸Š {max_char_count} æ–‡å­—ä»¥ä¸‹ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚
    """



    # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°: APIå‘¼ã³å‡ºã—å‰ã«å®Ÿè¡Œã•ã‚Œã€ãƒ•ãƒ©ã‚°ã‚’Trueã«ã™ã‚‹
    def set_generating_flag():
        st.session_state["is_generating"] = True
        st.session_state["generated_ge"] = "" # æ–°ã—ã„ç”Ÿæˆã®å‰ã«ä»¥å‰ã®çµæœã‚’ã‚¯ãƒªã‚¢



    # é€ä¿¡ãƒœã‚¿ãƒ³ã€‚ is_generatingãŒTrueã®é–“ã¯ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    # on_clickãƒãƒ³ãƒ‰ãƒ©ã‚’è¿½åŠ ã—ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸç¬é–“ã«ãƒ•ãƒ©ã‚°ã‚’Trueã«è¨­å®š
    if st.button("ğŸ› ï¸è‡ªå·±PRã‚’ç”Ÿæˆ", disabled=st.session_state["is_generating"], on_click=set_generating_flag):
        if not user_keywords_ge:
            st.warning("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æœ€ä½ä¸€ã¤å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
            st.session_state["is_generating"] = False
        elif not user_episode:
            st.warning("ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
            st.session_state["is_generating"] = False
        elif not user_job_or_subject:
            st.warning("è·ç¨®ã¾ãŸã¯å­¦ç§‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
            st.session_state["is_generating"] = False
        else:
            # on_clickã§ãƒ•ãƒ©ã‚°è¨­å®šæ¸ˆã¿ã®ãŸã‚ã€ã“ã“ã§ã¯ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤ºã¨APIå‘¼ã³å‡ºã—ã®ã¿ã‚’è¡Œã†
            with st.spinner("GeminiãŒè‡ªå·±PRã‚’ä½œæˆä¸­..."):
                for k in range(5):
                    try:
                        # Gemini APIå‘¼ã³å‡ºã—
                        response = client.models.generate_content(
                            model='gemini-2.5-flash',
                            contents=prompt
                        )

                        # ç”Ÿæˆçµæœã®æ–‡å­—æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                        generated_text = response.text.strip()
                        st.session_state['now_char_count'] = len(generated_text)

                        #æ–‡å­—æ•°ã®æ¡ä»¶
                        if min_char_count <= st.session_state["now_char_count"] <= max_char_count:
                            # æ¡ä»¶ã‚’æº€ãŸã—ãŸå ´åˆã®ã¿è¡¨ç¤ºãƒ»ä¿å­˜
                            st.session_state["generated_ge"] = generated_text
                            #ä¿å­˜çµæœnotå‡ºåŠ›ãƒ•ãƒ©ã‚°
                            st.session_state['displayed'] = True

                            st.success(f"ğŸ‰ è‡ªå·±PRãŒå®Œæˆã—ã¾ã—ãŸï¼ï¼ˆæ–‡å­—æ•°: {st.session_state['now_char_count']}æ–‡å­—ï¼‰")
                            st.subheader("ç”Ÿæˆã•ã‚ŒãŸè‡ªå·±PR")
                            st.write(st.session_state["generated_ge"])
                            #ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
                            st.download_button(
                            label="ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                            data=st.session_state["generated_ge"].encode("utf-8-sig"),
                            file_name="PR_GE.txt",
                            mime="text/plain"
                            )
                            break
                        else:
                            # æ¡ä»¶ã‚’æº€ãŸã•ãªã„å ´åˆã¯å†ç”Ÿæˆ
                            st.warning(f"å†ç”Ÿæˆã—ã¾ã™ï¼ˆç¾åœ¨ã®æ–‡å­—æ•°: {st.session_state['now_char_count']}æ–‡å­—ï¼‰")


                    except Exception as e:
                        st.error(f"APIå‘¼ã³å‡ºã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
                        break
                        
                st.session_state["is_generating"] = False
                if st.session_state["generated_ge"] == "":
                      st.warning("å†å®Ÿè¡Œã—ã¦ãã ã•ã„")



    #ä¿æŒå‡ºåŠ›å†…å®¹è¡¨ç¤º
    if  st.session_state["generated_ge"] != "" and st.session_state['displayed'] == False:
      st.success(f"ğŸ‰ è‡ªå·±PRãŒå®Œæˆã—ã¾ã—ãŸï¼ï¼ˆæ–‡å­—æ•°: {st.session_state['now_char_count']}æ–‡å­—ï¼‰")
      st.subheader("ç”Ÿæˆã•ã‚ŒãŸè‡ªå·±PR")
      st.write(st.session_state["generated_ge"])
      #ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
      st.download_button(
      label="ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
      data=st.session_state["generated_ge"].encode("utf-8-sig"),
      file_name="PR_GE.txt",
      mime="text/plain"
      )


# ----------------------------------------
# AIé¢æ¥è³ªå•
# ----------------------------------------
def AI_QU():

    #ä¿æŒå‡ºåŠ›å†…å®¹è¡¨ç¤ºãƒ•ãƒ©ã‚°
    st.session_state['displayed'] = False

    #åˆ©ç”¨ã‚·ãƒ¼ãƒ³ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
    user_use = st.sidebar.radio("åˆ©ç”¨ã‚·ãƒ¼ãƒ³", ["æ–°å’é¸è€ƒ", "ä¸­é€”é¸è€ƒ","å…¥å­¦é¸è€ƒ"])

    #è·ç¨®å­¦ç§‘å…¥åŠ›
    user_job_or_subject = st.sidebar.text_input("å¿—æœ›ã™ã‚‹è·ç¨®ã¾ãŸã¯å­¦æ ¡")

    #è³ªå•æ•°ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
    question_count = st.sidebar.slider("è³ªå•æ•°", 1, 10, 1)

    #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›
    user_keywords_qu = st.text_area(
        "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (å¼·ã¿ã€ã‚¹ã‚­ãƒ«ã€å®Ÿç¸¾ãªã©ã‚’è¤‡æ•°è¡Œã§å…¥åŠ›)",
        placeholder="ä¾‹:\nPythonã¨ãƒ‡ãƒ¼ã‚¿åˆ†æã‚¹ã‚­ãƒ«\nãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼çµŒé¨“3å¹´\né¡§å®¢æº€è¶³åº¦20%å‘ä¸Šã«è²¢çŒ®"
    )

    #ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆåŒ–
    keyword_list = [k.strip() for k in user_keywords_qu.split('\n') if k.strip()]
    keywords_formatted = "\n- " + "\n- ".join(keyword_list)

    #è‡ªå·±PRå…¥åŠ›
    user_pr = st.text_area(
        "è‡ªå·±PRã®ç´ æå…¥åŠ›ï¼ˆAIé¢æ¥å®˜ã«ä¼ãˆãŸã„å®Ÿç¸¾ãƒ»è‡ªå·±PRï¼‰",
        placeholder="ä¾‹:\nå‰è·ã§ãƒ‡ãƒ¼ã‚¿åé›†ã®è‡ªå‹•åŒ–ã‚’ææ¡ˆã—ã€Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è‡ªä½œã—ã¦é€±10æ™‚é–“ã®ä½œæ¥­å‰Šæ¸›ã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚"
    )


    prompt = f"""
        ã‚ãªãŸã¯ã€åˆ©ç”¨ã‚·ãƒ¼ãƒ³ **{user_use}** ã«ãŠã‘ã‚‹å¿œå‹Ÿè·ç¨®ï¼ˆã¾ãŸã¯å­¦ç§‘ï¼‰ **{user_job_or_subject}** ã®æ¡ç”¨é¢æ¥ã‚’æ‹…å½“ã™ã‚‹ã€**å³æ ¼ã§çµŒé¨“è±Šå¯Œãªãƒ—ãƒ­ã®é¢æ¥å®˜AI** ã§ã™ã€‚

        ã€ç›®çš„ã€‘
        ä»¥ä¸‹ã®è‡ªå·±PRæ–‡ã‚’ã‚‚ã¨ã«ã€å€™è£œè€…ã®çœŸå®Ÿæ€§ï¼ˆå†ç¾æ€§ï¼‰ã€æ·±ã•ï¼ˆæ€è€ƒåŠ›ï¼‰ã€å¿œç”¨åŠ›ï¼ˆãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ï¼‰ã‚’è¦‹æŠœããŸã‚ã®è³ªå•ã‚’ä½œæˆã—ã¾ã™ã€‚

        ã€çµ¶å¯¾ãƒ«ãƒ¼ãƒ«ã€‘
        1. è³ªå•ã¯ **{question_count}å€‹ã¡ã‚‡ã†ã©** å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚
        2. å„è³ªå•ã®å‰ã«å¿…ãš **ã€Œ1.ã€ã€Œ2.ã€...** ã®ã‚ˆã†ã«åŠè§’æ•°å­—ï¼‹ãƒ”ãƒªã‚ªãƒ‰ã§ç•ªå·ã‚’ä»˜ã‘ã‚‹ã“ã¨ã€‚
        3. è³ªå•æ–‡ä»¥å¤–ï¼ˆèª¬æ˜æ–‡ã€æŒ¨æ‹¶ã€ã‚¿ã‚¤ãƒˆãƒ«ã€è£œè¶³ã€åŒºåˆ‡ã‚Šç·šã€ç©ºè¡Œãªã©ï¼‰ã¯ä¸€åˆ‡å‡ºåŠ›ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚
        4. å„è³ªå•ã¯1æ–‡ä»¥å†…ã€å¥ç‚¹ï¼ˆã€‚)ã§çµ‚ã‚ã‚‹ã“ã¨ã€‚
        5. å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ä»¥ä¸‹ã®ä¾‹ã¨**å®Œå…¨ã«ä¸€è‡´**ã•ã›ã‚‹ã“ã¨ã€‚

        ã€å‡ºåŠ›ä¾‹ï¼ˆè³ªå•æ•°ãŒ3ã®å ´åˆï¼‰ã€‘
        1. ã“ã®è‡ªå·±PRã§è¿°ã¹ãŸè¡Œå‹•ã‚’å–ã‚‹ãã£ã‹ã‘ã¯ä½•ã§ã—ãŸã‹ã€‚
        2. æ•°å€¤çš„æˆæœã‚’ã©ã®ã‚ˆã†ã«æ¸¬å®šã—ã¾ã—ãŸã‹ã€‚
        3. åŒæ§˜ã®çŠ¶æ³ã§å†ç¾ã™ã‚‹ãŸã‚ã«æ„è­˜ã—ã¦ã„ã‚‹ã“ã¨ã¯ä½•ã§ã™ã‹ã€‚

        ã€å…¥åŠ›æƒ…å ±ã€‘
        ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {keywords_formatted}
        è‡ªå·±PR: {user_pr}

        ã€å‡ºåŠ›ã‚¿ã‚¹ã‚¯ã€‘
        ä¸Šè¨˜ã‚’åŸºã«ã€**{question_count}å€‹ã®è³ªå•**ã‚’æ­£ç¢ºã«å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
        """


    # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°: APIå‘¼ã³å‡ºã—å‰ã«å®Ÿè¡Œã•ã‚Œã€ãƒ•ãƒ©ã‚°ã‚’Trueã«ã™ã‚‹
    def set_generating_flag():
        st.session_state["is_generating"] = True
        st.session_state["generated_qu"] = "" # æ–°ã—ã„ç”Ÿæˆã®å‰ã«ä»¥å‰ã®çµæœã‚’ã‚¯ãƒªã‚¢

    # é€ä¿¡ãƒœã‚¿ãƒ³ã€‚ is_generatingãŒTrueã®é–“ã¯ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    # on_clickãƒãƒ³ãƒ‰ãƒ©ã‚’è¿½åŠ ã—ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸç¬é–“ã«ãƒ•ãƒ©ã‚°ã‚’Trueã«è¨­å®š
    if st.button("ğŸ› ï¸é¢æ¥è³ªå•ã‚’ç”Ÿæˆ", disabled=st.session_state["is_generating"], on_click=set_generating_flag) :
        if not user_keywords_qu:
            st.warning("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æœ€ä½ä¸€ã¤å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
            st.session_state["is_generating"] = False
        elif not user_pr:
            st.warning("è‡ªå·±PRã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
            st.session_state["is_generating"] = False
        elif not user_job_or_subject:
            st.warning("è·ç¨®ã¾ãŸã¯å­¦ç§‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
            st.session_state["is_generating"] = False
        else:
            # on_clickã§ãƒ•ãƒ©ã‚°è¨­å®šæ¸ˆã¿ã®ãŸã‚ã€ã“ã“ã§ã¯ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤ºã¨APIå‘¼ã³å‡ºã—ã®ã¿ã‚’è¡Œã†
            with st.spinner("GeminiãŒè³ªå•ã‚’ä½œæˆä¸­..."):
                try:
                    response = client.models.generate_content(
                        model='gemini-2.5-flash',
                        contents = prompt
                      )

                    # çµæœã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã«ä¿å­˜
                    st.session_state["generated_qu"] = response.text
                    #ä¿å­˜çµæœnotå‡ºåŠ›ãƒ•ãƒ©ã‚°
                    st.session_state['displayed'] = True

                    # çµæœã®è¡¨ç¤º
                    st.success("ğŸ‰ é¢æ¥æƒ³å®šè³ªå•ãŒå®Œæˆã—ã¾ã—ãŸï¼")
                    st.subheader("AIé¢æ¥å®˜ã®è³ªå•ãƒªã‚¹ãƒˆ")
                    st.write(st.session_state["generated_qu"])
                    #ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
                    st.download_button(
                    label="ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                    data=st.session_state["generated_qu"].encode("utf-8-sig"),
                    file_name="AI_QU.txt",
                    mime="text/plain"
                    )

                except Exception as e:
                    st.error(f"APIå‘¼ã³å‡ºã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

                finally:
                    # å‡¦ç†ã®æˆåŠŸ/å¤±æ•—ã«é–¢ã‚ã‚‰ãšã€æœ€å¾Œã«ãƒ•ãƒ©ã‚°ã‚’Falseã«æˆ»ã™
                    st.session_state["is_generating"] = False



    #ä¿æŒå‡ºåŠ›å†…å®¹è¡¨ç¤º
    if  st.session_state["generated_qu"] != "" and st.session_state['displayed'] == False:
        st.success("ğŸ¤ é¢æ¥æƒ³å®šè³ªå•ãŒå®Œæˆã—ã¾ã—ãŸï¼")
        st.subheader("AIé¢æ¥å®˜ã®è³ªå•ãƒªã‚¹ãƒˆ")
        st.write(st.session_state["generated_qu"])
        #ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
        st.download_button(
        label="ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
        data=st.session_state["generated_qu"].encode("utf-8-sig"),
        file_name="AI_QU.txt",
        mime="text/plain"
    )


# ----------------------------------------
# AIé¢æ¥è©•ä¾¡
# ----------------------------------------
def AI_EV():

    #ä¿æŒå‡ºåŠ›å†…å®¹è¡¨ç¤ºãƒ•ãƒ©ã‚°
    st.session_state['displayed'] = False

    #åˆ©ç”¨ã‚·ãƒ¼ãƒ³ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
    user_use = st.sidebar.radio("åˆ©ç”¨ã‚·ãƒ¼ãƒ³", ["æ–°å’é¸è€ƒ", "ä¸­é€”é¸è€ƒ","å…¥å­¦é¸è€ƒ"])

    #è·ç¨®å­¦ç§‘å…¥åŠ›
    user_job_or_subject = st.sidebar.text_input("å¿—æœ›ã™ã‚‹è·ç¨®ã¾ãŸã¯å­¦æ ¡")

    #è©•ä¾¡ã®å³ã—ã•ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
    strict_level = st.sidebar.slider("è©•ä¾¡ã®å³ã—ã•", 1, 5, 1)

    #è³ªå•æ–‡å…¥åŠ›
    user_question = st.text_area(
    "è³ªå•æ–‡(é¢æ¥å®˜ã«èã‹ã‚Œã‚‹è³ªå•ã‚’å…¥åŠ›)",
    placeholder="ä¾‹:\nè‡ªå·±PRã§ã‚¢ãƒ”ãƒ¼ãƒ«ã§ãã‚‹å¼·ã¿ã‚’æ•™ãˆã¦ãã ã•ã„"
    )

    #å›ç­”å…¥åŠ›
    user_answer = st.text_area(
    "å›ç­”ï¼ˆè³ªå•ã«å¯¾ã™ã‚‹å›ç­”ã‚’å…¥åŠ›ï¼‰",
    placeholder="ä¾‹:\nç§ã®å¼·ã¿ã¯è²¬ä»»æ„Ÿã®å¼·ã•ã§ã™ã€‚ã©ã‚“ãªçŠ¶æ³ã§ã‚‚æœ€å¾Œã¾ã§ã‚„ã‚Šé‚ã’ã‚‹å§¿å‹¢ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã€‚"
    )


    prompt = f"""
    ã‚ãªãŸã¯ã€åˆ©ç”¨ã‚·ãƒ¼ãƒ³ **{user_use}** ã®å¿œå‹Ÿè·ç¨®ï¼ˆã¾ãŸã¯å­¦ç§‘ï¼‰ **{user_job_or_subject}** ã®æ¡ç”¨ã‚’ä»»ã•ã‚ŒãŸã€
    **å³æ ¼ã§çµŒé¨“è±Šå¯Œãªé¢æ¥å®˜** ã§ã™ã€‚

    ã€ç”Ÿæˆã‚¿ã‚¹ã‚¯ã€‘
    ä»¥ä¸‹ã®ã€è³ªå•æ–‡ã€‘ã‚’å…ƒã«ã€å›ç­”ã€‘ã‚’ç´°ã‹ãåˆ†æã—ã€
    **ä»¥ä¸‹ã®ã€Œè©•ä¾¡é …ç›®ã€ã«åŸºã¥ãã€100ç‚¹æº€ç‚¹ã§æ¡ç‚¹ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ»æ”¹å–„æ¡ˆã®ç”Ÿæˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

    ---

    ã€è©•ä¾¡æ–¹é‡ã€‘
    è©•ä¾¡ã®å³ã—ã•ãƒ¬ãƒ™ãƒ«ï¼š**{strict_level} / 5**
    ï¼ˆæ•°å€¤ãŒé«˜ã„ã»ã©ã‚ˆã‚Šå³æ ¼ãƒ»ã‚·ãƒ“ã‚¢ã«æ¡ç‚¹ãƒ»æŒ‡æ‘˜ã‚’è¡Œã£ã¦ãã ã•ã„ï¼‰

    ### è©•ä¾¡å³ã—ã•ãƒ¬ãƒ™ãƒ«åˆ¥ã®åŸºæº–
    | ãƒ¬ãƒ™ãƒ« | æ¡ç‚¹ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ–¹é‡ |
    |:-------:|:------------------|
    | **1ï¼ˆç”˜å£ï¼‰** | ç©æ¥µçš„ã«è‰¯ã„ç‚¹ã‚’è©•ä¾¡ã—ã€æ¸›ç‚¹ã¯æœ€å°é™ã€‚è¨€è‘‰é£ã„ã‚‚æŸ”ã‚‰ã‹ãã€åŠ±ã¾ã™ã‚ˆã†ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸­å¿ƒã«ã™ã‚‹ã€‚ |
    | **2ï¼ˆã‚„ã‚„ç”˜å£ï¼‰** | é•·æ‰€ã‚’é‡è¦–ã—ã¤ã¤ã€è»½ã„æ”¹å–„ç‚¹ã‚’æŒ‡æ‘˜ã€‚å…¨ä½“çš„ã«ãƒã‚¸ãƒ†ã‚£ãƒ–ãªãƒˆãƒ¼ãƒ³ã‚’ç¶­æŒã€‚ |
    | **3ï¼ˆä¸­ç«‹ï¼‰** | ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸè©•ä¾¡ã€‚è‰¯ã„ç‚¹ãƒ»æ”¹å–„ç‚¹ã®ä¸¡æ–¹ã‚’æ˜ç¢ºã«è¿°ã¹ã€å…¬å¹³ã«æ¡ç‚¹ã™ã‚‹ã€‚ |
    | **4ï¼ˆã‚„ã‚„è¾›å£ï¼‰** | å†…å®¹ã®æ·±ã•ãƒ»è«–ç†æ€§ã‚’å³ã—ãç²¾æŸ»ã—ã€ä¸ååˆ†ãªéƒ¨åˆ†ã‚’å…·ä½“çš„ã«æŒ‡æ‘˜ã™ã‚‹ã€‚ç‚¹æ•°ã‚‚ã‚„ã‚„å³ã—ã‚ã«ã€‚ |
    | **5ï¼ˆæ¿€è¾›ãƒ»å³æ ¼ï¼‰** | å°‚é–€å®¶ãƒ¬ãƒ™ãƒ«ã®åŸºæº–ã§è©•ä¾¡ã€‚æ›–æ˜§ãƒ»æŠ½è±¡çš„ãªè¡¨ç¾ã‚’å¼·ãæ¸›ç‚¹ã—ã€å…·ä½“æ€§ãƒ»ä¸€è²«æ€§ãƒ»èª¬å¾—åŠ›ã‚’å³å¯†ã«æ±‚ã‚ã‚‹ã€‚ |

    ---

    ### è©•ä¾¡é …ç›®
    1. **è«–ç†æ€§ã¨æ§‹é€  (30ç‚¹)**ï¼šå›ç­”ã®ä¸»å¼µã¨æ ¹æ‹ ãŒæ˜ç¢ºã«ç¹‹ãŒã‚Šã€æ§‹é€ åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ã€‚
    2. **å…·ä½“æ€§ã¨æ·±ã• (40ç‚¹)**ï¼šæŠ½è±¡è«–ã«çµ‚ã‚ã‚‰ãšã€å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚„ãƒ‡ãƒ¼ã‚¿ã€ç‹¬è‡ªã®è¦–ç‚¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã€‚
    3. **è·å‹™ï¼ˆã¾ãŸã¯å­¦ç§‘ï¼‰ã¨ã®é–¢é€£æ€§ (30ç‚¹)**ï¼šå¿œå‹Ÿè€…ãŒã“ã®è·ç¨®ã‚„åˆ†é‡ã§æ´»èºã§ãã‚‹ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚’æ„Ÿã˜ã•ã›ã‚‹å†…å®¹ã‹ã€‚

    ---

    ### ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆå½¢å¼
    ä¸Šè¨˜ã®åˆ†æã¨æ¡ç‚¹ã«åŸºã¥ãã€**å¿…ãšä»¥ä¸‹ã®ã€è¦‹å‡ºã—å½¢å¼ã€‘ã§**å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

    ---
    ## ç·åˆç‚¹
    **(åˆè¨ˆç‚¹ / 100ç‚¹)**

    ---
    ## è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    * **è‰¯ã„ç‚¹**
        * (å›ç­”ã®è©•ä¾¡ç‚¹ã‚„é•·æ‰€ã‚’å…·ä½“çš„ã«1ç‚¹ç›®)
        * (å›ç­”ã®è©•ä¾¡ç‚¹ã‚„é•·æ‰€ã‚’å…·ä½“çš„ã«2ç‚¹ç›®)
    * **æ”¹å–„ç‚¹**
        * (å›ç­”ã®ä¸è¶³ç‚¹ã‚„æ”¹å–„ãŒå¿…è¦ãªç‚¹ã‚’å…·ä½“çš„ã«1ç‚¹ç›®)
        * (å›ç­”ã®ä¸è¶³ç‚¹ã‚„æ”¹å–„ãŒå¿…è¦ãªç‚¹ã‚’å…·ä½“çš„ã«2ç‚¹ç›®)
    ---
    ## ç·è©•
    å…¨ä½“ã¨ã—ã¦(å›ç­”å…¨ä½“ã®å°è±¡ã‚’ã¾ã¨ã‚ã‚‹)ã€‚
    ---
    ## æ”¹å–„æ¡ˆ
   ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’åæ˜ ã—ãŸã€ã‚ˆã‚Šè‰¯ã„å›ç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
  ï¼ˆå…ƒã®å›ç­”ã®æ–‡ç« ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€æ”¹å–„ç‚¹ã‚’ä¿®æ­£ã—ã¦1ã¤ã®å›ç­”ã¨ã—ã¦å‡ºåŠ›ï¼‰

    ---
    ã€è³ªå•æ–‡ã€‘
    è³ªå•æ–‡ - {user_question}

    ã€å›ç­”ã€‘
    å›ç­” - {user_answer}
    """

      # ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°: APIå‘¼ã³å‡ºã—å‰ã«å®Ÿè¡Œã•ã‚Œã€ãƒ•ãƒ©ã‚°ã‚’Trueã«ã™ã‚‹
    def set_generating_flag():
        st.session_state["is_generating"] = True
        st.session_state["generated_ev"] = "" # æ–°ã—ã„ç”Ÿæˆã®å‰ã«ä»¥å‰ã®çµæœã‚’ã‚¯ãƒªã‚¢

    # é€ä¿¡ãƒœã‚¿ãƒ³ã€‚ is_generatingãŒTrueã®é–“ã¯ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    # on_clickãƒãƒ³ãƒ‰ãƒ©ã‚’è¿½åŠ ã—ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸç¬é–“ã«ãƒ•ãƒ©ã‚°ã‚’Trueã«è¨­å®š
    if st.button("ğŸ› ï¸è©•ä¾¡ã‚’ç”Ÿæˆ", disabled=st.session_state["is_generating"], on_click=set_generating_flag) :
        if not user_question:
            st.warning("è³ªå•æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
            st.session_state["is_generating"] = False
        elif not user_answer:
            st.warning("å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
            st.session_state["is_generating"] = False
        elif not user_job_or_subject:
            st.warning("è·ç¨®ã¾ãŸã¯å­¦ç§‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
            st.session_state["is_generating"] = False
        else:
            # on_clickã§ãƒ•ãƒ©ã‚°è¨­å®šæ¸ˆã¿ã®ãŸã‚ã€ã“ã“ã§ã¯ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤ºã¨APIå‘¼ã³å‡ºã—ã®ã¿ã‚’è¡Œã†
            with st.spinner("GeminiãŒè©•ä¾¡ã‚’ä½œæˆä¸­..."):
                try:
                    response = client.models.generate_content(
                        model='gemini-2.5-flash',
                        contents = prompt
                      )

                    # çµæœã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã«ä¿å­˜
                    st.session_state["generated_ev"] = response.text
                    #ä¿å­˜çµæœnotå‡ºåŠ›ãƒ•ãƒ©ã‚°
                    st.session_state['displayed'] = True

                    # çµæœã®è¡¨ç¤º
                    st.success("ğŸ‰ è©•ä¾¡ãŒå®Œæˆã—ã¾ã—ãŸï¼")
                    st.subheader("AIé¢æ¥å®˜ã®è©•ä¾¡")
                    st.write(st.session_state["generated_ev"])
                    #ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
                    st.download_button(
                    label="ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                    data=st.session_state["generated_ev"].encode("utf-8-sig"),
                    file_name="AI_EV.txt",
                    mime="text/plain"
                    )

                except Exception as e:
                    st.error(f"APIå‘¼ã³å‡ºã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

                finally:
                    # å‡¦ç†ã®æˆåŠŸ/å¤±æ•—ã«é–¢ã‚ã‚‰ãšã€æœ€å¾Œã«ãƒ•ãƒ©ã‚°ã‚’Falseã«æˆ»ã™
                    st.session_state["is_generating"] = False

        #ä¿æŒå‡ºåŠ›å†…å®¹è¡¨ç¤º
    if  st.session_state["generated_ev"] != "" and st.session_state['displayed'] == False :
        st.success("ğŸ‰ è©•ä¾¡ãŒå®Œæˆã—ã¾ã—ãŸï¼")
        st.subheader("AIé¢æ¥å®˜ã®è©•ä¾¡")
        st.write(st.session_state["generated_ev"])
        #ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
        st.download_button(
        label="ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
        data=st.session_state["generated_ev"].encode("utf-8-sig"),
        file_name="AI_EV.txt",
        mime="text/plain"
        )


# ----------------------------------------
# ç”»é¢é·ç§»å‡¦ç†
# ----------------------------------------
if   user_mode == "è‡ªå·±PRç”Ÿæˆ":
     PR_GE()
elif user_mode == "AIé¢æ¥è³ªå•":
     AI_QU()
elif user_mode == "AIé¢æ¥è©•ä¾¡":
     AI_EV()
